"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildExplicitPackageJsonDependencies = void 0;
const project_graph_models_1 = require("../project-graph-models");
const fileutils_1 = require("@nrwl/workspace/src/utilities/fileutils");
const devkit_1 = require("@nrwl/devkit");
function buildExplicitPackageJsonDependencies(ctx, nodes, addDependency, fileRead) {
    Object.keys(ctx.fileMap).forEach((source) => {
        Object.values(ctx.fileMap[source]).forEach((f) => {
            if (isPackageJsonAtProjectRoot(nodes, f.file)) {
                processPackageJson(source, f.file, nodes, addDependency, fileRead);
            }
        });
    });
}
exports.buildExplicitPackageJsonDependencies = buildExplicitPackageJsonDependencies;
function isPackageJsonAtProjectRoot(nodes, fileName) {
    return Object.values(nodes).find((projectNode) => (projectNode.type === 'lib' || projectNode.type === 'app') &&
        devkit_1.joinPathFragments(projectNode.data.root, 'package.json') === fileName);
}
function processPackageJson(sourceProject, fileName, nodes, addDependency, fileRead) {
    try {
        const deps = readDeps(fileutils_1.parseJsonWithComments(fileRead(fileName)));
        deps.forEach((d) => {
            // package.json refers to another project in the monorepo
            if (nodes[d]) {
                addDependency(project_graph_models_1.DependencyType.static, sourceProject, d);
            }
        });
    }
    catch (e) {
        if (process.env.NX_VERBOSE_LOGGING) {
            console.log(e);
        }
    }
}
function readDeps(packageJsonDeps) {
    var _a, _b;
    return [
        ...Object.keys((_a = packageJsonDeps === null || packageJsonDeps === void 0 ? void 0 : packageJsonDeps.dependencies) !== null && _a !== void 0 ? _a : {}),
        ...Object.keys((_b = packageJsonDeps === null || packageJsonDeps === void 0 ? void 0 : packageJsonDeps.devDependencies) !== null && _b !== void 0 ? _b : {}),
    ];
}
//# sourceMappingURL=explicit-package-json-dependencies.js.map